{% extends '::base.html.twig' %}

{% block container %}
    <div class="" id="googleMap" style="top:-20px;height:460px;">
    </div>
{% endblock %}

{% block javascripts %}
    <script type="text/javascript">
        $(document).ready(function() {
            google.maps.event.addDomListener(window, 'load', initialize);

            $('form[role="search"]').on('submit', function(event){
                event.preventDefault();
                //markers.addMarker(markers.getLatLng(18.1240011,-77.3144547));
                markers.deleteOverlays();

                formData = $(this).serializeArray();

                find(formData);
            });

            find();
        });

        function find(data) {
            $.ajax({
                url: Routing.generate('tourism_markers_data'),
                dataType: 'json',
                method: 'get',
                data: data
            }).done(function(response, statusText, jqXHR){
                var pois = response;

                markers.arrayMarkers = [];

                $.each(pois, function(key, value){
                    var marker = markers.addMarker(value);

                    google.maps.event.addListener(marker, 'click', function() {
                        var infowindow = new InfoBubble({
                            content: this.poi_popover,
                            maxWidth: 500
                        });

                        infowindow.open(map.object, this);
                    });
                });

                markers.markerCluster = new MarkerClusterer(map.object, markers.arrayMarkers);
            });
        }

        var map = {
            object: undefined
        };
        var markers = {
            arrayMarkers: [],
            markerCluster: undefined,
            getLatLng: function(lat, lng){
                return new google.maps.LatLng(lat, lng);
            },
            addMarker: function (object) {
                var marker = new google.maps.Marker({
                    position: markers.getLatLng(object.lat, object.lng),
                    title: object.nombre,
                    poi_id: object.id,
                    poi_nombre: object.nombre,
                    poi_popover: object.popover
                });

                markers.arrayMarkers.push(marker);

                return marker;
            },
            deleteOverlays: function() {
                if (markers.arrayMarkers) {
                    for (i in markers.arrayMarkers) {
                        markers.arrayMarkers[i].setMap(null);
                    }
                    markers.arrayMarkers.length = 0;
                }
                if (markers.markerCluster) {
                    markers.markerCluster.clearMarkers();
                }
            }
        };

        function initialize() {
            var mapProp = {
                center:new google.maps.LatLng(18.1240011,-77.3144547),
                zoom:10,
                mapTypeId:google.maps.MapTypeId.ROADMAP
            };
            map.object = new google.maps.Map(document.getElementById("googleMap"),mapProp);

//            placeMarker(new google.maps.LatLng(51.508742,-0.120850));
//            google.maps.event.addListener(marker, 'click', toggleBounce);

//            marker.setMap(map);

        }

//        function placeMarker(location) {
//            var marker = new google.maps.Marker({
//                position: location,
//                map: map,
//            });
//            var infowindow = new google.maps.InfoWindow({
//                content: 'Latitude: ' + location.lat() +
//                '<br>Longitude: ' + location.lng()
//            });
//            infowindow.open(map, marker);
//        }
    </script>
{% endblock javascripts %}